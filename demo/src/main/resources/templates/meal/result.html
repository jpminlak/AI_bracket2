<!DOCTYPE html>
<html lang="kor" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>추천 식단</title>
    <link rel="stylesheet" th:href="@{/main.css}">
</head>
<style>
    .wrap {
        max-width: 980px;
        margin: 30px auto;
        font-family: system-ui, sans-serif
    }

    .cards {
        display: flex;
        gap: 20px;
        margin: 20px 0
    }

    .card {
        flex: 1;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 16px;
        text-align: center
    }

    .card.exceeded {
        border-color: #ff6b6b;
        background-color: #fff5f5;
    }

    .card.normal {
        border-color: #51cf66;
        background-color: #f8fff9;
    }

    .kcal {
        margin-top: 8px;
        color: #666
    }

    .total {
        font-weight: 600;
        margin-top: 12px
    }

    .nutri {
        margin-top: 6px;
        color: #6b7280
    }

    .nutri b {
        font-weight: 600
    }

    .warning {
        background-color: #ffe3e3;
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        padding: 12px;
        margin: 16px 0;
        color: #d63031;
    }

    .info {
        background-color: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 12px;
        margin: 16px 0;
        color: #1976d2;
    }

    .nutrition-summary {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
    }

    .nutrition-item {
        display: inline-block;
        margin: 4px 8px;
        padding: 4px 8px;
        background-color: white;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .btn {
        padding: 10px 16px;
        border: 0;
        border-radius: 10px;
        background: #1f7aec;
        color: #fff;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 5px;
    }

    .btn-save {
        background: #28a745;
    }

    .btn-back {
        background: #6c757d;
    }
</style>

<body>
    <header th:replace="~{common:: header}"></header>
    <main>
        <div class="wrap">
            <h2 th:text="${memberName} + '님을 위한 다음 식사 (' + mealLabel + ')'"></h2>
            <p th:text="${dietDate} + ' ' + ${dayOfWeek}" style="color:#555"></p>

            <!-- 초과 여부에 따른 경고/정보 메시지 -->
            <div th:if="${isExceeded}" class="warning">
                ⚠️ 주의: 일일 권장량을 초과하여 섭취하셨습니다. 다이어트를 고려해보세요.
            </div>
            <div th:if="${!isExceeded}" class="info">
                ✅ 균형 잡힌 영양 섭취를 위한 추천 식단입니다.
            </div>

            <!-- 일일 영양소 현황 -->
            <div class="nutrition-summary">
                <h4>일일 영양소 현황</h4>
                <div>
                    <span class="nutrition-item">
                        <strong>권장 칼로리:</strong> <span
                            th:text="${#numbers.formatDecimal(dailyRequirement.calories, 0, 0)}">0</span> kcal
                    </span>
                    <span class="nutrition-item">
                        <strong>현재까지 섭취:</strong> <span
                            th:text="${#numbers.formatDecimal(consumedTotal.calories, 0, 0)}">0</span> kcal
                    </span>
                </div>
                <div style="margin-top: 8px;">
                    <span class="nutrition-item">
                        탄수화물: <span th:text="${#numbers.formatDecimal(consumedTotal.carbohydrates, 0, 1)}">0</span>g /
                        <span th:text="${#numbers.formatDecimal(dailyRequirement.carbohydrates, 0, 1)}">0</span>g
                    </span>
                    <span class="nutrition-item">
                        단백질: <span th:text="${#numbers.formatDecimal(consumedTotal.protein, 0, 1)}">0</span>g /
                        <span th:text="${#numbers.formatDecimal(dailyRequirement.protein, 0, 1)}">0</span>g
                    </span>
                    <span class="nutrition-item">
                        지방: <span th:text="${#numbers.formatDecimal(consumedTotal.fat, 0, 1)}">0</span>g /
                        <span th:text="${#numbers.formatDecimal(dailyRequirement.fat, 0, 1)}">0</span>g
                    </span>
                </div>
            </div>

            <div class="cards">
                <div class="card" th:classappend="${isExceeded} ? 'exceeded' : 'normal'"
                    th:if="${recommendedFoods != null}">
                    <h3 th:text="${mealLabel} + ' 추천 메뉴'"></h3>
                    <!-- 음식 이름 나열 -->
                    <div style="margin: 12px 0;">
                        <span th:each="f, iterStat : ${recommendedFoods}">
                            <strong th:text="${f.foodName}"></strong><span th:if="${!iterStat.last}">, </span>
                        </span>
                    </div>

                    <!-- 추천 식사의 영양 정보 -->
                    <div class="nutri">
                        <div>
                            <b th:text="${#numbers.formatDecimal(totalCalories, 0, 0)}">0</b> kcal
                        </div>
                        <div style="margin-top: 4px; font-size: 12px;">
                            탄수화물 <b th:text="${#numbers.formatDecimal(totalCarbs, 0, 1)}">0</b>g ·
                            단백질 <b th:text="${#numbers.formatDecimal(totalProtein, 0, 1)}">0</b>g ·
                            지방 <b th:text="${#numbers.formatDecimal(totalFat, 0, 1)}">0</b>g
                        </div>
                    </div>

                    <!-- 상세 음식별 영양정보 -->
                    <div style="margin-top: 16px; text-align: left; font-size: 13px;">
                        <h5>상세 영양정보:</h5>
                        <div th:each="f : ${recommendedFoods}"
                            style="margin: 4px 0; padding: 4px; background: #f9f9f9; border-radius: 4px;">
                            <strong th:text="${f.foodName}">음식명</strong><br>
                            <span style="color: #666;">
                                <span th:text="${#numbers.formatDecimal(f.calories, 0, 1)}">0</span>kcal,
                                탄<span th:text="${#numbers.formatDecimal(f.carbohydrates, 0, 1)}">0</span>g,
                                단<span th:text="${#numbers.formatDecimal(f.protein, 0, 1)}">0</span>g,
                                지<span th:text="${#numbers.formatDecimal(f.fat, 0, 1)}">0</span>g
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <p style="margin-top:16px;color:#555; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                <strong>추천 이유:</strong> <span th:text="${reason}"></span>
            </p>

            <!-- 저장 및 뒤로가기 버튼 -->
            <div style="margin-top:24px; text-align: center;">
                <form method="post" th:action="@{/diet/save}" style="display: inline;">
                    <input type="hidden" name="dietDate" th:value="${dietDate}">
                    <input type="hidden" th:name="${mealTime}" th:value="${foodNamesString}">
                    <input type="hidden" th:name="${mealTime + '_kcal'}" th:value="${totalCalories}">
                    <input type="hidden" th:name="${mealTime + '_carbs'}" th:value="${totalCarbs}">
                    <input type="hidden" th:name="${mealTime + '_protein'}" th:value="${totalProtein}">
                    <input type="hidden" th:name="${mealTime + '_fat'}" th:value="${totalFat}">
                    <button class="btn btn-save" type="submit">이 식단 저장</button>
                </form>
                <a href="/diet" class="btn btn-back">식단 화면으로 돌아가기</a>
            </div>
        </div>
    </main>
    <footer th:replace="~{common:: footer}"></footer>
</body>

</html>